#!/bin/sh
#
# Author: Aaron Voisine <aaron@voisine.org>
# Inkscape Modifications:
#	Michael Wybrow <mjwybrow@users.sourceforge.net>
#	Jean-Olivier Irisson <jo.irisson@gmail.com>
# AlgoScore modifications:
#       Jonatan Liljedahl <lijon@kymatica.com>

CWD="`(cd \"\`dirname \\\"$0\\\"\`\"; echo $PWD)`"
# e.g. /Applications/AlgoScore.app/Contents/Resources/bin
TOP="`dirname \"$CWD\"`"
# e.g. /Applications/AlgoScore.app/Contents/Resources

# Brutally add many things to the PATH. If the directories do not exist, they won't be used anyway. 
# People should really use ~/.macosx/environment.plist to set environment variables as explained by Apple:
#	http://developer.apple.com/qa/qa2001/qa1067.html
# but since no one does, we correct this by making the 'classic' PATH additions here:
export PATH="/usr/local/bin:$PATH"

export DYLD_LIBRARY_PATH="$TOP/lib"

export FONTCONFIG_PATH="$TOP/etc/fonts"
export PANGO_RC_FILE="$HOME/.algoscore-etc/pangorc"
export GTK_IM_MODULE_FILE="$HOME/.algoscore-etc/gtk.immodules"
export GDK_PIXBUF_MODULE_FILE="$HOME/.algoscore-etc/gdk-pixbuf.loaders"
export GTK_DATA_PREFIX="$TOP"
export GTK_EXE_PREFIX="$TOP"
export GNOME_VFS_MODULE_CONFIG_PATH="$TOP/etc/gnome-vfs-2.0/modules"
export GNOME_VFS_MODULE_PATH="$TOP/lib/gnome-vfs-2.0/modules"

# Handle the case where the directory storing the app has a '#' in the name.
# This '#' needs to be escaped in pango.modules for Pango to work properly.
ESCAPEDTOP=`echo $TOP | sed 's/#/\\\\\\\\#/'`

mkdir -p ${HOME}/.algoscore-etc
sed 's|${HOME}|'"$HOME|g" "$TOP/etc/pango/pangorc" > ${HOME}/.algoscore-etc/pangorc
sed 's|${CWD}|'"$ESCAPEDTOP|g" "$TOP/etc/pango/pango.modules" \
    > ${HOME}/.algoscore-etc/pango.modules
cp -f "$TOP/etc/pango/pangox.aliases" ${HOME}/.algoscore-etc/
sed 's|${CWD}|'"$TOP|g" "$TOP/etc/gtk-2.0/gtk.immodules" \
    > ${HOME}/.algoscore-etc/gtk.immodules
sed 's|${CWD}|'"$TOP|g" "$TOP/etc/gtk-2.0/gdk-pixbuf.loaders" \
    > ${HOME}/.algoscore-etc/gdk-pixbuf.loaders

exec "$CWD/algoscore-bin" "$@"